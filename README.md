# Docker image with `nginx`

> **nginx** - веб-сервер и почтовый прокси-сервер, работающий на Unix-подобных операционных системах

Для того, что бы вытянуть образ себе на локальную машину необходимо выполнить:

```bash
$ docker login registry.gitlab.com
$ docker pull registry.gitlab.com/avto-internal/docker/nginx:latest
```

## Переопределение значений в конфигурационном файле

> Конфигурация по-умолчанию не содержит настроек серверов

При сборке образа происходит установка крайней стабильной версии nginx, и происходит замена конфигурационных файлов теми, что содержатся в данном репозитории (оригинальные файлы **не удаляются**, с просто перезаписываются).

Конфигурационный файл `nginx.conf` содержит конструкции вида:

```dotenv
user %NGINX_USER|www-data%;

pid %NGINX_PID_FILE|/var/run/nginx.pid%;
daemon %NGINX_DAEMON|off%;
# ...
```

Что сделано для того, чтобы `entrypoint` скрипт перед запуском master-процесса произвёл замену внутри данных паттернов на одноименные значения из переменных окружения (если переменная окружения не будет обнаружена - замена произойдёт на значение, указанное после символа `|`).

Таким образом, если в определенных условиях вам надо будет, например, изменить путь к лог-файлу ошибок - вам достаточно передать в контейнер переменную `NGINX_ERROR_LOG_PATH` со значением `/tmp/nginx_errors.log` - и "прокидывать" отдельный конфигурационный файл целиком не придётся:

```bash
$ docker run -e NGINX_ERROR_LOG_PATH='/tmp/nginx_errors.log' ...
```

## Переопределение конфигурационного файла

Для того, что бы переопределить конфигурационный файл "целиком", вам достаточно передать в контейнер переменную окружения `NGINX_CONFIG_OVERRIDE` с путём к файлу конфигурации, который должен быть установлен "основным". Например:

```bash
$ docker run \
  -e NGINX_CONFIG_OVERRIDE='/shared/volume/my_nginx.conf' \
  ...
```

Если переменная окружения `NGINX_CONFIG_OVERRIDE` будет обнаружена - `entrypoint` скрипт скопирует по указанному пути файл, разместив его по пути `/etc/nginx/nginx.conf`.

> В вашем конфигурационном файле вы так же можете использовать переопределение значений из значений окружения, описанные выше


## Конфигурации http, servers

Для того, что бы "сообщить" `nginx` настройки своих серверов (и не только, eq: `upstream`), достаточно передать в контейнер переменную окружения `NGINX_HTTP_CONFIGS` с путями к файлам конфигураций, которые должны быть включены в секции `http { ... }` основного конфигурационного файла (`include ...`). Файлы должны иметь расширение `.conf` и быть разделены одиночным пробелом, например:

```bash
$ docker run \
  -e NGINX_HTTP_CONFIGS='/shared/volume/server.conf /shared/volume/server.ssl.conf /shared/volume/upstream.conf' \
  ...
```

Если переменная окружения `NGINX_HTTP_CONFIGS` будет обнаружена - `entrypoint` скрипт скопирует каждый указанный файл в директорию `/etc/nginx/conf.d` перед запуском master-процесса.

## Работа с SSL

Образ содержит самоподписанный SSL-сертификат, для его использования в переопределенных (своих) конфигах в секции `server` достаточно добавить:

```
ssl on;
include ssl/self-signed.conf;
```

## Страницы ошибок

Образ содержит переопределенные страницы ошибок. Для того, чтоб они начали работать в твоей секции `server` достаточно добавить:

```
include includes/errorpages.conf;
```

## Автоматическая установка прав доступа к директориям для nginx

Так как после запуска контейнера необходимо установить соответствующие права доступа на директории, с которыми должен работать nginx (`www-data:www-data`), вы можете передать при запуске контейнера переменную окружения `WWW_DATA_ACCESSIBLE_DIRS` - в этом случае для директорий, указанных через пробел (` `) в этой переменной будет установлен пользователь и группа `www-data:www-data` (по умолчанию) рекурсивно:

```bash
$ docker run \
  -e WWW_DATA_ACCESSIBLE_DIRS='/path/to/www /path/to/another/www' \
  ...
```

За данное поведение отвечает `entrypoint` скрипт.